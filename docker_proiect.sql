CREATE TABLE FACULTATE (
    id_facultate NUMBER (6),
    facultate_nume VARCHAR2(20) NOT NULL
);

CREATE TABLE SPECIALITATE (
    id_specialitate NUMBER(6) PRIMARY KEY,
    id_facultate NUMBER(6) NOT NULL,
    specialitate_nume VARCHAR2(20) NOT NULL,
    nr_ani NUMBER(1) NOT NULL
);

ALTER TABLE FACULTATE
ADD PRIMARY KEY(ID_FACULTATE);

ALTER TABLE SPECIALITATE
ADD FOREIGN KEY(ID_FACULTATE) REFERENCES FACULTATE(ID_FACULTATE);

CREATE TABLE GRUPA(
    id_grupa NUMBER(6) PRIMARY KEY,
    id_specialitate NUMBER(6) NOT NULL,
    grupa_numar NUMBER(4) NOT NULL,
    FOREIGN KEY (ID_SPECIALITATE) REFERENCES SPECIALITATE(ID_SPECIALITATE)
);

CREATE TABLE STUDENT(
    id_student NUMBER(6) PRIMARY KEY,
    id_grupa NUMBER(6) NOT NULL,
    cnp NUMBER(13) NOT NULL,
    st_nume VARCHAR2(20) NOT NULL,
    data_nastere DATE,
    bursier VARCHAR2(2) NOT NULL ,
    email VARCHAR2(20),
    telefon NUMBER(10),
    CONSTRAINT CHK_CNP CHECK (CNP BETWEEN POWER(10, 12) AND POWER(10, 13)),
    CONSTRAINT CHK_BURSIER CHECK (BURSIER = 'DA' OR BURSIER = 'NU'),
    FOREIGN KEY (ID_GRUPA) REFERENCES GRUPA(ID_GRUPA)
);

CREATE TABLE PLATA(
    id_plata NUMBER(6) PRIMARY KEY,
    id_student NUMBER(6) NOT NULL REFERENCES STUDENT(ID_STUDENT),
    suma NUMBER(5) NOT NULL,
    data_plata DATE NOT NULL
);

CREATE TABLE PROFESOR(
    id_profesor NUMBER(6) PRIMARY KEY,
    id_facultate NUMBER(6) NOT NULL REFERENCES FACULTATE(ID_FACULTATE),
    cnp NUMBER(13, 13) NOT NULL,
    prof_nume VARCHAR(20) NOT NULL,
    data_nastere DATE,
    email VARCHAR(20),
    telefon NUMBER(10)
);

CREATE TABLE MATERIE(
    id_materie NUMBER(6) PRIMARY KEY,
    id_specialitate NUMBER(6) NOT NULL REFERENCES SPECIALITATE(ID_SPECIALITATE),
    id_profesor NUMBER(6) NOT NULL REFERENCES PROFESOR(ID_PROFESOR),
    materie_nume VARCHAR2(20) NOT NULL,
    nr_credite NUMBER(1)
);

CREATE TABLE NOTA(
    id_student NUMBER(6) NOT NULL REFERENCES STUDENT(ID_STUDENT),
    id_materie NUMBER(6) NOT NULL REFERENCES MATERIE(ID_MATERIE),
    nota NUMBER(2)
);

ALTER TABLE NOTA
ADD PRIMARY KEY(ID_STUDENT, ID_MATERIE);

CREATE TABLE SALA(
    id_sala NUMBER(6) PRIMARY KEY,
    id_facultate NUMBER(6) NOT NULL REFERENCES FACULTATE(ID_FACULTATE),
    sala_numar NUMBER(4) NOT NULL
);

CREATE TABLE PLANIFICARE(
    id_grupa NUMBER(6) REFERENCES GRUPA(ID_GRUPA),
    id_materie NUMBER(6) REFERENCES MATERIE(ID_MATERIE),
    id_sala NUMBER(6) REFERENCES SALA(ID_SALA),
    p_data DATE NOT NULL,
    PRIMARY KEY (ID_GRUPA, ID_MATERIE, p_data)
);

CREATE TABLE EVENIMENT(
    id_eveniment NUMBER(6) PRIMARY KEY,
    id_facultate NUMBER(6) NOT NULL REFERENCES FACULTATE(ID_FACULTATE),
    eveniment_nume VARCHAR2(20) NOT NULL,
    eveniment_data DATE
);

CREATE TABLE EVENIMENT_STUDENT(
    id_eveniment NUMBER(6) REFERENCES EVENIMENT(ID_EVENIMENT),
    id_student NUMBER(6) REFERENCES STUDENT(ID_STUDENT),
    eveniment_rol VARCHAR2(20),
    PRIMARY KEY (ID_EVENIMENT, ID_STUDENT)
);

ALTER TABLE GRUPA
ADD UNIQUE (ID_SPECIALITATE, GRUPA_NUMAR);

ALTER TABLE SPECIALITATE
ADD UNIQUE (ID_FACULTATE, SPECIALITATE_NUME);

ALTER TABLE STUDENT
ADD UNIQUE (CNP);

ALTER TABLE PROFESOR
ADD UNIQUE (CNP);

ALTER TABLE MATERIE
ADD UNIQUE (ID_SPECIALITATE, MATERIE_NUME);

ALTER TABLE SALA
ADD UNIQUE (ID_FACULTATE, SALA_NUMAR);

ALTER TABLE STUDENT
MODIFY EMAIL VARCHAR2(50);

ALTER TABLE PROFESOR
MODIFY EMAIL VARCHAR2(50);

ALTER TABLE PROFESOR
MODIFY CNP NUMBER(13) CHECK (CNP BETWEEN POWER(10, 12) AND POWER(10, 13)) ;

ALTER TABLE STUDENT
ADD UNIQUE (EMAIL);

ALTER TABLE STUDENT
ADD UNIQUE(TELEFON);

INSERT INTO FACULTATE VALUES (1, 'FMI');
INSERT INTO FACULTATE VALUES (2, 'FPSE');
INSERT INTO FACULTATE VALUES (3, 'FGG');
INSERT INTO FACULTATE VALUES (4, 'FAA');
INSERT INTO FACULTATE VALUES (5, 'FACULTATEA DE DREPT');

INSERT INTO SPECIALITATE VALUES (11, 1, 'MATEMATICA', 3);
INSERT INTO SPECIALITATE VALUES (12, 1, 'INFORMATICA', 3);
INSERT INTO SPECIALITATE VALUES (13, 1, 'CTI', 3);
INSERT INTO SPECIALITATE VALUES (31, 3, 'GEOGRAFIA', 4);
INSERT INTO SPECIALITATE VALUES (32, 3, 'GEOGRAFIA TURISMULUI', 3);
INSERT INTO SPECIALITATE VALUES (51, 5, 'STIINTI POLITICE', 4);

INSERT INTO GRUPA VALUES (111, 11, 101);
INSERT INTO GRUPA VALUES (121, 12, 142);
INSERT INTO GRUPA VALUES (122, 12, 143);
INSERT INTO GRUPA VALUES (131, 13, 101);
INSERT INTO GRUPA VALUES (321, 32, 113);
INSERT INTO GRUPA VALUES (123, 12, 151);

INSERT INTO STUDENT VALUES (1111, 111, 5003475889523, 'DAN MIHAI', '23-02-2001', 'DA', 'dan.mihai@gmail.com', 0702455541);
INSERT INTO STUDENT VALUES (1211, 121, 5003122218934, 'BARABOI ADRIAN', '28-11-2001', 'DA', 'baraboi.adrian@gmail.com', 0788985571);
INSERT INTO STUDENT VALUES (1212, 121, 1950521340486, 'CERNAT MIHAI', '12-12-2001', 'NU', 'cernat.mihai@gmail.com', 0777514944);
INSERT INTO STUDENT VALUES (1311, 131, 2890612063449, 'DARIE EMANUEL', '14-09-2002', 'DA', 'darie.emanuel@gmail.com', 0789688768);
INSERT INTO STUDENT VALUES (1312, 131, 6050322260678, 'ENACHE SORIN', '28-11-2002', 'NU', 'enache sorin@gmail.com', NULL);
INSERT INTO STUDENT VALUES (1313, 131, 2890123516661, 'FLOREA IONEL', '05-06-2001', 'NU', NULL, 0714218018);
INSERT INTO STUDENT VALUES (1314, 131, 2960618189324, 'LASCU MIHAELA', '01-01-2002', 'DA', NULL, 069246817);
INSERT INTO STUDENT VALUES (1231, 123, 6040113468294, 'MOREGA MIHAI', NULL, 'DA', 'morega.mihai@gmail.com', 0737517128);

INSERT INTO PROFESOR VALUES (11, 1, 5003475889523, 'MUNTEANU ADRIAN', '13-02-1985', 'munteanu.adrian@gmail.com', 0791942957);
INSERT INTO PROFESOR VALUES (12, 1, 5003122218934, 'POPA DORIN', '01-09-1982', 'popa.dorin@gmail.com', 0723905851);
INSERT INTO PROFESOR VALUES (21, 2, 1950521340486, 'POPESCU CLAUDIA', '04-11-1976', 'popescu_claudia@gmail.com', 0761331192);
INSERT INTO PROFESOR VALUES (41, 4, 2890612063449, 'RAB LAURA', '14-08-1995', 'no_rab_laura@gmail.com', NULL);
INSERT INTO PROFESOR VALUES (42, 4, 6050322260678, 'ENACHE SORIN', '15-07-1970', 'enache_sorin@gmail.com', 0752349106);
INSERT INTO PROFESOR VALUES (51, 5, 2890123516661, 'URSACHI CORNEL', '03-02-1971', NULL, NULL);
INSERT INTO PROFESOR VALUES (31, 3, 1955661347786, 'VONCILA ION', '04-11-1976', 'voncilia.ion@gmail.com', NULL);

INSERT INTO PLATA VALUES (1, 1212, 3400, '17-09-2022');
INSERT INTO PLATA VALUES (2, 1312, 1700, '10-08-2022');
INSERT INTO PLATA VALUES (3, 1312, 1700, '07-01-2023');
INSERT INTO PLATA VALUES (4, 1313, 1000, '26-10-2022');
INSERT INTO PLATA VALUES (5, 1313, 1000, '11-11-2022');

INSERT INTO MATERIE VALUES (111, 11, 11, 'ALGEBRA LINIARA', 6);
INSERT INTO MATERIE VALUES (121, 12, 12, 'STRUCTURI DE DATE', 5);
INSERT INTO MATERIE VALUES (122, 12, 12, 'BAZE DE DATE', 6);
INSERT INTO MATERIE VALUES (123, 12, 12, 'ARHITECTURA CALCUL', 6);
INSERT INTO MATERIE VALUES (131, 13, 11, 'MICRO ELECTRONICA', 7);
INSERT INTO MATERIE VALUES (311, 31, 31, 'FIZICA 1', 4);
INSERT INTO MATERIE VALUES (511, 51, 51, 'POLITICA EXTERNA', 3);

INSERT INTO NOTA VALUES (1111, 111, 8);
INSERT INTO NOTA VALUES (1211, 121, 7);
INSERT INTO NOTA VALUES (1211, 122, 5);
INSERT INTO NOTA VALUES (1211, 123, 9);
INSERT INTO NOTA VALUES (1212, 121, 8);
INSERT INTO NOTA VALUES (1212, 122, 10);
INSERT INTO NOTA VALUES (1212, 123, 9);
INSERT INTO NOTA VALUES (1311, 131, 3);
INSERT INTO NOTA VALUES (1312, 131, 2);
INSERT INTO NOTA VALUES (1313, 131, 5);
INSERT INTO NOTA VALUES (1314, 131, 6);

INSERT INTO SALA VALUES (101, 1, 101);
INSERT INTO SALA VALUES (102, 1, 102);
INSERT INTO SALA VALUES (103, 1, 205);
INSERT INTO SALA VALUES (104, 1, 207);
INSERT INTO SALA VALUES (201, 2, 101);
INSERT INTO SALA VALUES (401, 4, 125);
INSERT INTO SALA VALUES (402, 4, 12);
INSERT INTO SALA VALUES (501, 5, 3);

INSERT INTO PLANIFICARE VALUES (111, 111, 101, '19-04-2023');
INSERT INTO PLANIFICARE VALUES (121, 121, 102, '21-04-2023');
INSERT INTO PLANIFICARE VALUES (121, 122, 102, '22-04-2023');
INSERT INTO PLANIFICARE VALUES (121, 123, NULL, '22-04-2023');
INSERT INTO PLANIFICARE VALUES (131, 131, 102, '19-04-2023');
INSERT INTO PLANIFICARE VALUES (123, 121, 104, '24-04-2023');
INSERT INTO PLANIFICARE VALUES (111, 111, 102, '26-04-2023');
INSERT INTO PLANIFICARE VALUES (121, 121, 102, '27-04-2023');
INSERT INTO PLANIFICARE VALUES (131, 131, NULL, '25-04-2023');
INSERT INTO PLANIFICARE VALUES (121, 123, 102, '30-04-2023');

INSERT INTO EVENIMENT VALUES (101, 1, 'BALUL BOBOCILOR', '23-10-2022');
INSERT INTO EVENIMENT VALUES (102, 1, 'BLACK AND WHITE', '25-12-2022');
INSERT INTO EVENIMENT VALUES (103, 1, 'HALLOWEEN', '31-10-2022');
INSERT INTO EVENIMENT VALUES (201, 2, 'HALLOWEEN', '31-10-2022');
INSERT INTO EVENIMENT VALUES (403, 4, 'HALLOWEEN', '31-10-2022');
INSERT INTO EVENIMENT VALUES (104, 1, 'SHOW DE TALENTE', '10-02-2023');

INSERT INTO EVENIMENT_STUDENT VALUES (101, 1111, 'organizator');
INSERT INTO EVENIMENT_STUDENT VALUES (101, 1211, 'organizator');
INSERT INTO EVENIMENT_STUDENT VALUES (101, 1312, 'regele');
INSERT INTO EVENIMENT_STUDENT VALUES (101, 1314, 'regina');
INSERT INTO EVENIMENT_STUDENT VALUES (102, 1312, 'organizator');
INSERT INTO EVENIMENT_STUDENT VALUES (102, 1314, 'juriu');
INSERT INTO EVENIMENT_STUDENT VALUES (104, 1212, 'juriu');
INSERT INTO EVENIMENT_STUDENT VALUES (104, 1314, 'juriu');
INSERT INTO EVENIMENT_STUDENT VALUES (104, 1111, 'participant');
INSERT INTO EVENIMENT_STUDENT VALUES (104, 1211, 'participant');
INSERT INTO EVENIMENT_STUDENT VALUES (104, 1313, 'participant');
INSERT INTO EVENIMENT_STUDENT VALUES (104, 1231, 'participant');
INSERT INTO EVENIMENT_STUDENT VALUES (102, 1111, NULL);
INSERT INTO EVENIMENT_STUDENT VALUES (102, 1231, NULL);


SELECT ST_NUME 
FROM STUDENT 
WHERE ID_GRUPA IN (
    SELECT ID_GRUPA 
    FROM PLANIFICARE
    WHERE ID_SALA = 102
    GROUP BY ID_GRUPA
    HAVING COUNT(*)>=2)
    AND ID_GRUPA IN (
        SELECT ID_GRUPA 
        FROM GRUPA 
        WHERE ID_SPECIALITATE IN (
            SELECT ID_SPECIALITATE
            FROM SPECIALITATE
            WHERE UPPER(SPECIALITATE_NUME) = 'INFORMATICA'
            )
        );


SELECT ST_NUME, DATA_NASTERE
FROM (
    SELECT *
    FROM STUDENT
    WHERE ID_GRUPA IN (
        SELECT ID_GRUPA
        FROM GRUPA
        WHERE GRUPA_NUMAR = 142)
    ORDER BY DATA_NASTERE
    )
WHERE ROWNUM<=3;

    

WITH EV AS (
    SELECT ID_STUDENT, NVL(EVENIMENT_ROL, 'anonim') ROL
    FROM EVENIMENT_STUDENT  
    )
SELECT S.ID_STUDENT, S.ST_NUME, DECODE(S.BURSIER, 'DA', 'BURSIER', 'CONTRACT'), E.ROL
FROM STUDENT S
JOIN EV E ON E.ID_STUDENT = S.ID_STUDENT
ORDER BY LENGTH(S.ST_NUME);


SELECT S.ST_NUME, 
    CASE
        WHEN COUNT(N.ID_MATERIE)>0
        THEN
            CASE 
                WHEN MIN(N.NOTA)>=5
                    THEN TO_CHAR(AVG(N.NOTA))
                ELSE 'restantier'
            END
        ELSE 'nici o nota'
    END SITUATIA_SCOLARA
FROM STUDENT S
FULL OUTER JOIN NOTA N ON S.ID_STUDENT = N.ID_STUDENT
GROUP BY S.ST_NUME, S.ID_STUDENT;


SELECT S.SPECIALITATE_NUME
FROM SPECIALITATE S
WHERE S.ID_SPECIALITATE IN (
    SELECT G.ID_SPECIALITATE
    FROM GRUPA G
    WHERE G.ID_SPECIALITATE = S.ID_SPECIALITATE
        AND G.ID_GRUPA IN (
        SELECT P.ID_GRUPA
        FROM PLANIFICARE P
        WHERE ADD_MONTHS(P.P_DATA,1) = ROUND(SYSDATE) AND P.ID_GRUPA = G.ID_GRUPA
        )
)


UPDATE NOTA 
SET NOTA = NOTA +  1
WHERE ID_MATERIE = (
    SELECT ID_MATERIE
    FROM MATERIE 
    WHERE MATERIE_NUME = 'ALGEBRA LINIARA'
    );


UPDATE STUDENT
SET BURSIER = 'NU'
WHERE ID_STUDENT IN (
    SELECT S.ID_STUDENT
    FROM STUDENT S
    JOIN NOTA N ON S.ID_STUDENT = N.ID_STUDENT
    GROUP BY S.ID_STUDENT
    HAVING AVG(N.NOTA)<5
    );

UPDATE PLANIFICARE
SET ID_SALA = NULL
WHERE ID_GRUPA = (
    SELECT ID_GRUPA 
    FROM GRUPA 
    WHERE GRUPA_NUMAR = 151 AND ID_SPECIALITATE IN (
        SELECT ID_SPECIALITATE
        FROM SPECIALITATE
        WHERE ID_FACULTATE = (
            SELECT ID_FACULTATE
            FROM FACULTATE
            WHERE FACULATE_NUME = 'FMI'
            )
        )
    ) AND TO_CHAR(P_DATA) = '24-04-2023';


DELETE FROM MATERIE
WHERE ID_MATERIE NOT IN (
    SELECT ID_MATERIE
    FROM NOTA);


DELETE FROM EVENIMENT
WHERE ID_EVENIMENT NOT IN (
    SELECT ID_EVENIMENT
    FROM EVENIMENT_STUDENT
    );

    
DELETE FROM STUDENT
WHERE ID_STUDENT IN (
    SELECT S.ID_STUDENT
    FROM STUDENT S
    FULL OUTER JOIN PLATA P ON S.ID_STUDENT = P.ID_STUDENT
    WHERE S.BURSIER = 'NU'
    GROUP BY S.ID_STUDENT
    HAVING SUM(P.SUMA)<3000 OR SUM(P.SUMA) IS NULL
    );


CREATE VIEW PROFESOR_NOTA AS
SELECT P.ID_PROFESOR, P.ID_FACULTATE, P.PROF_NUME, M.MATERIE_NUME, N.NOTA
FROM PROFESOR P
JOIN MATERIE M ON P.ID_PROFESOR = M.ID_PROFESOR
JOIN NOTA N ON N.ID_MATERIE = M.ID_MATERIE;

SELECT *
FROM PROFESOR_NOTA


SELECT F.FACULTATE_NUME, S.SPECIALITATE_NUME, G.GRUPA_NUMAR, ST.ST_NUME, N.NOTA
FROM FACULTATE F
FULL OUTER JOIN specialitate S ON F.ID_FACULTATE = S.ID_FACULTATE
FULL OUTER JOIN GRUPA G ON G.ID_SPECIALITATE = S.ID_SPECIALITATE
FULL OUTER JOIN STUDENT ST ON ST.ID_GRUPA = G.ID_GRUPA
FULL OUTER JOIN NOTA N ON N.ID_STUDENT = ST.ID_STUDENT;


SELECT DISTINCT S.ID_STUDENT
FROM EVENIMENT_STUDENT S
WHERE NOT EXISTS((
    SELECT E.ID_EVENIMENT
    FROM EVENIMENT E
    WHERE E.ID_FACULTATE = (
        SELECT ID_FACULTATE
        FROM FACULTATE
        WHERE FACULTATE_NUME = 'FMI'))
    MINUS
    (SELECT E.ID_EVENIMENT
    FROM EVENIMENT E, EVENIMENT_STUDENT ES
    WHERE E.ID_EVENIMENT = ES.ID_EVENIMENT AND ES.ID_STUDENT = S.ID_STUDENT));

SELECT ST_NUME
FROM (
    SELECT S.ST_NUME
    FROM EVENIMENT_STUDENT ES
    JOIN STUDENT S ON ES.ID_STUDENT = S.ID_STUDENT
    GROUP BY S.ST_NUME
    ORDER BY COUNT(ES.ID_EVENIMENT) DESC
    )
WHERE ROWNUM <=3;


